<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" caontent="width=device-width, initial-scale=1, user-scalable=0">
		<title>点击右上角−−−−></title>
	</head>
	<body>
		<script type="text/javascript">
		/**
         * 获取参数的键值对象。
         * @returns {Object}
         */
        function getParam() {
			try{ 
				var url = window.location.href;
				var result = url.split("?")[1];
				var keyValue = result.split("&");
				var obj = {};
				for (var i = 0; i < keyValue.length; i++) {
					var item = keyValue[i].split("=");
					obj[item[0]] = item[1];
				}
				return obj;
			}
			catch(e){
				console.warn("There has no param value!");
			}
        };
		/**
         * 微信跳转函数。
         */		
		function wechatOptimized(imgLink,targetLink){
			var ua = navigator.userAgent
			var uat = navigator.userAgent.toLowerCase();
			var isWeixin = uat.indexOf('micromessenger') != -1; //微信内访问
			var isAndroid = ua.indexOf('Android') != -1; //android终端
			var isiOS = !!ua.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端
			var browserWidth = document.body.clientWidth;
			if(isWeixin && isiOS){
				document.body.innerHTML = '<div><img src="https://www.qingqubaike.com/wp-content/uploads/2017/08/ios.png" /></div><div><img src="' + imgLink + '"/></div>';
			}
			else if(isWeixin && isAndroid){
				document.body.innerHTML = '<div class ="scaled"><img src="https://www.qingqubaike.com/wp-content/uploads/2017/08/android.jpg" /></div><div><img src="' + imgLink + '"/></div>';
			}
			else {
				window.location.href= targetLink;
			}
		}
		/**
         * 加载xml文件方法
         */
		function loadXMLDoc(url) {
			xmlhttp=null;
			if (window.XMLHttpRequest) {
				// code for IE7, Firefox, Mozilla, etc.
				xmlhttp=new XMLHttpRequest();
			}
			else if (window.ActiveXObject) {
				// code for IE5, IE6
				xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
			}
			if (xmlhttp!=null) {
				xmlhttp.onreadystatechange=onResponse;
				xmlhttp.open("GET",url,true);
				xmlhttp.send(null);
			}
			else {
				alert("Your browser does not support XMLHTTP.");
			}
			return xmlhttp;
		}

		
		/**
         * 根据超链参数将赋值对应的图片和跳转链接
         */	
		var xmlhttp;
		var xmlhttp = loadXMLDoc("config.xml");
		function onResponse() {
			/**
			*等待XMLHttpRequest HTTP 响应已经完全接收。
			*/
			if(xmlhttp.readyState!=4) return;
			if(xmlhttp.status!=200) {
				alert("Problem retrieving XML data");
				return;
			}
			//解析xml内容
			var xmlContent = xmlhttp.responseXML;
			var homepage = xmlContent.getElementsByTagName("homepage");
			var productItem = xmlContent.getElementsByTagName("product")[0].getElementsByTagName("item");
			var downloadItem = xmlContent.getElementsByTagName("download")[0].getElementsByTagName("item");		
			var linkParameter = getParam();
			var linkType = getParam().type;
			var linkValue = getParam().value; 
			//根据传参为微信所需参数从xml中检索value并赋值
			if (linkType == 1) {
				//product of taobao
				for (i=0;i<productItem.length;i++) {
					var productItemId = productItem [i].getElementsByTagName("product-id")[0].firstChild.nodeValue;
					if (productItemId == linkValue) {
						var imgLink = productItem [i].getElementsByTagName("product-img")[0].firstChild.nodeValue;
						var targetLink = productItem [i].getElementsByTagName("product-link")[0].firstChild.nodeValue;
					}
				}

			}
			else if (linkType == 2) {
				//android application
				for (i=0;i<downloadItem.length;i++) {
					var downloadItemId = downloadItem [i].getElementsByTagName("app-name")[0].firstChild.nodeValue;
					if (downloadItemId == linkValue) {
						var imgLink = downloadItem [i].getElementsByTagName("app-img")[0].firstChild.nodeValue;
						var targetLink = downloadItem [i].getElementsByTagName("app-link")[0].firstChild.nodeValue;
					}
				}		
			}
			else {
				// linkType为0或者其它错误值时均提示跳转主页
				var imgLink = homepage[0].getElementsByTagName("home-img")[0].firstChild.nodeValue;
				var targetLink = homepage[0].getElementsByTagName("home-link")[0].firstChild.nodeValue ;
			}
			//执行微信跳转检查函数
			wechatOptimized(imgLink,targetLink);
		}
	

		
		</script>
		<style type="text/css">
			body{
				background-color: #eee;
				text-align:center;
				overflow-x:hidden;
			}
			div{
				padding: 0;	
				margin: 0;
				text-align: center;
				vertical-align: top;
			}
			img{
				text-align:center;
				max-width:100%;
			}
		</style>
	</body>
</html>
